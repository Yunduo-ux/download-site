<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="color-scheme" content="dark light">
  <title>云朵 · 下载中心</title>

  <!-- 图标：确保根目录有真正 ICO；加版本号避免缓存 -->
  <link rel="icon" href="/favicon.ico?v=3" type="image/x-icon" sizes="any">
  <link rel="shortcut icon" href="/favicon.ico?v=3" type="image/x-icon">
  <link rel="icon" href="/favicon-32.png?v=3" sizes="32x32" type="image/png">
  <link rel="icon" href="/favicon-16.png?v=3" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png?v=3">
  <meta name="theme-color" content="#0f172a">

  <style>
    body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC}
    .wrap{max-width:760px;margin:8vh auto;padding:24px}
    h1{margin:0 0 8px;font-size:28px}
    p{opacity:.9}
    .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:20px;margin-top:16px}
    .btn{display:block;text-align:center;padding:14px 16px;border-radius:12px;text-decoration:none;font-weight:600;margin:10px 0}
    .primary{background:#22c55e;color:#052e16}
    .secondary{background:#1f2937;color:#e5e7eb;border:1px solid #374151}
    small{opacity:.7}
    code{background:#0b1220;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>云朵 · 安装包下载</h1>
    <p>最新版：<b class="version">加载中…</b> · 体积约 300+ MB</p>

    <div class="card">
      <!-- 不暴露真实链接：href="#" + data-url -->
      <a id="dl-main" class="btn primary" href="#" data-url="">全球线路</a>
      <a id="dl-github" class="btn secondary" href="#" data-url="">备用线路</a>

      <p><small>
        若某条线路慢/打不开，请切换另一条。下载后请校验 <code>SHA256</code>：
        <b id="sha256">0E399A5375792076CD6845209609254F3C8DEFBEEF582251AB2AA3D6F9B5DCDB</b>
      </small></p>
    </div>

    <div class="card">
      <h3>历史版本</h3>
      <div id="history">加载历史版本中…</div>
    </div>

    <p><small>© 云朵下载中心 · 仅分发页面，不收集个人信息。</small></p>
  </div>

  <script>
  const owner = "Yunduo-ux";
  const repo  = "download-site";
  const originBase   = location.origin;                          // https://download.leizhenyu.xyz
  const mirrorProbe  = `${originBase}/dl/ping`;
  const mirrorLatest = `${originBase}/dl/latest`;
  const stableName   = "Yunduo_Setup.zip";                       // 稳定文件名
  const ghLatest     = `https://github.com/${owner}/${repo}/releases/latest/download/${stableName}`;

  function bindButton(a){
    a.addEventListener('click', e=>{
      e.preventDefault();
      const url = a.dataset.url;
      if(!url) return;

      // 同域镜像：用隐藏 iframe 实现不跳转；外域(GitHub)只跳一次，避免“双下载”
      if (url.startsWith(originBase)) {
        let f = document.getElementById('dl-frame');
        if(!f){ f=document.createElement('iframe'); f.id='dl-frame'; f.style.display='none'; document.body.appendChild(f); }
        try{ f.src = url; }catch(e){}
      } else {
        location.href = url;
      }
    });
  }

  async function setVersion(){
    try{
      const r  = await fetch(`https://api.github.com/repos/${owner}/${repo}/releases/latest`);
      const d  = await r.json();
      document.querySelector(".version").textContent = d.tag_name || "latest";
    }catch{}
  }

  async function probeAndSet(){
    // 先把“备用直链”写好，主按钮默认也先给 GitHub
    const main  = document.getElementById("dl-main");
    const ghBtn = document.getElementById("dl-github");
    main.dataset.url  = ghLatest;
    ghBtn.dataset.url = ghLatest;

    try{
      const r = await fetch(mirrorProbe, { method:"GET", cache:"no-store" });
      if (r.ok) main.dataset.url = mirrorLatest;  // 镜像可用则切过去
    }catch{}
  }

  async function buildHistory(limit=8){
    try{
      const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/releases?per_page=${limit}`);
      const list = await r.json();
      const box = document.getElementById("history");
      box.innerHTML = "";

      const useMirror = document.getElementById("dl-main").dataset.url === mirrorLatest;

      list.forEach(rel=>{
        const zips = (rel.assets||[]).filter(a=>/\.zip$/i.test(a.name));
        if(!zips.length) return;
        // 选名字里与 stableName 最接近的；没有就挑体积最大
        let best = zips.find(a => a.name.toLowerCase() === stableName.toLowerCase());
        if(!best) best = zips.sort((a,b)=>b.size-a.size)[0];

        const link = useMirror
          ? `${originBase}/dl/file/${encodeURIComponent(rel.tag_name)}/${encodeURIComponent(best.name)}`
          : `https://github.com/${owner}/${repo}/releases/download/${encodeURIComponent(rel.tag_name)}/${encodeURIComponent(best.name)}`;

        const a = document.createElement("a");
        a.className = "btn secondary";
        a.textContent = `${rel.tag_name} · ${best.name}`;
        a.href = "#";
        a.dataset.url = link;
        bindButton(a);
        box.appendChild(a);
      });
    }catch{
      document.getElementById("history").textContent = "历史版本加载失败";
    }
  }

  bindButton(document.getElementById("dl-main"));
  bindButton(document.getElementById("dl-github"));

  setVersion();
  probeAndSet().then(buildHistory);
  </script>
</body>
</html>
